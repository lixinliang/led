/*!
 * @project : 1438668322457
 * @version : 1.0.0
 * @author  : lixinliang
 * @update  : 2015-08-12 10:39:31 am
 */!function(global,factory){var plugin="LED";"function"==typeof define?define(plugin,function(){return factory()}):global[plugin]=factory()}(this,function(){function LED(conf){this.self=this,this.config=conf,this.stoped=!1}if(!document.querySelector)return console&&console.error&&console.error("Your browser is not supported"),void 0;var $=window.$||window.jQuery||window.Zepto;if("undefined"==typeof $){var $$=function(target){this[0]=target,this.length=1};$$.prototype={splice:Array.prototype.splice,on:function(event,callback){this[0].addEventListener(event,callback,!1)},off:function(event,callback){this[0].removeEventListener(event,callback,!1)}},$=function(selector){if("string"==typeof selector)return new $$(document.querySelector(selector));if("object"==typeof selector){if(selector===selector.window)return new $$(selector);if(selector.nodeType)return new $$(selector);if(selector[0]&&selector[0].nodeType)return new $$(selector[0])}},$.extend=function(){var target=arguments[0];target="object"==typeof target?target:{};for(var length=arguments.length,i=1;length>i;i++){var temp=arguments[i];for(var name in temp)target[name]=temp[name]}return target}}var S={};S.init=function(fn){var self=this;this.drawing.adjustCanvas(),fn(),this.drawing.loop(function(){return self.destroyed||self.shape.render()})},S.Drawing={loop:function(fn){this.renderFn=this.renderFn?this.renderFn:fn,this.clearFrame(),this.renderFn()||this.requestFrame.call(window,this.loop.bind(this,fn))},adjustCanvas:function(){var canvas=this.canvas;canvas.width=this.self.config.width,canvas.height=this.self.config.height,canvas.style.width=canvas.width+"px",canvas.style.height=canvas.height+"px"},clearFrame:function(){this.context.clearRect(0,0,this.canvas.width,this.canvas.height)},getArea:function(){return{w:this.canvas.width,h:this.canvas.height}},drawCircle:function(p,c){var context=this.context;context.fillStyle=c.render(),context.beginPath(),context.arc(p.x,p.y,p.z,0,2*Math.PI,!0),context.closePath(),context.fill()}},S.Command={extend:function(conf){if("object"==typeof conf)for(var i in conf)"extend"!=i&&(S.Command[i]=conf[i]);return this}},S.Core=function(){function formatTime(date){var h=date.getHours(),m=date.getMinutes();return m=10>m?"0"+m:m,h+":"+m}function getValue(value,partition){return value&&function(){var ret=value.split(partition);return ret.shift(),ret.join("")}()}function getAction(value,command,partition){return value=value&&value.split(partition)[0],value&&value.substring(0,command.length)===command&&value.substring(command.length)}function reset(){clearTimeout(this.timerId),this.sequence=[]}function clear(){this.shape.switchShape(this.shapeBuilder.letter(""))}function performAction(act){var config=this.self.config;this.sequence="object"==typeof act?act:this.sequence.concat(function(){var ret=[],temp=act.split(config.split),len=temp.length,last=temp[len-1];return temp.forEach(function(action){action&&ret.push(action)}),ret.length>0&&""===last&&ret.push(last),ret}())}function timedAction(callback){if(!this.destroyed){var config=this.self.config,sequence=this.sequence;if(!(sequence.length<=0)){var current=sequence.shift()||"",action=getAction(current,config.command,config.partition),value=getValue(current,config.partition),SCmd=S.Command,command={current:current,action:action,value:value,sequence:sequence},thisCommand=SCmd.hasOwnProperty(action)&&"function"==typeof SCmd[action]?action:"default";this.stopTrigger=!1,SCmd[thisCommand].call(this,command),this.stopTrigger||callback.call(this,command),this.prevCommand=thisCommand,this.timerId=setTimeout(timedAction.bind(this,callback),this.speed)}}}return S.Command.extend({count:function(command){var from,to,value=command.value.replace(/\s+/g,""),config=this.self.config,number=value.split(/from|to/);1==number.length?(from=parseInt(number[0]),to=config.maxCount):2==number.length?/from/.test(value)?(from=parseInt(number[1]),to=config.maxCount):(from=config.minCount,to=parseInt(number[1])):3==number.length?value.indexOf("from")<value.indexOf("to")?(from=parseInt(number[1]),to=parseInt(number[2])):(from=parseInt(number[2]),to=parseInt(number[1])):(from=parseInt(value),to=config.maxCount),from=isNaN(from)?config.minCount:0>from?config.minCount:from,to=isNaN(to)?config.maxCount:0>to?config.maxCount:to,to>from?(this.shape.switchShape(this.shapeBuilder.letter(from),!0),this.sequence.unshift(config.command+"count"+config.partition+"from"+(from+1)+"to"+to)):from>to?(this.shape.switchShape(this.shapeBuilder.letter(config.error)),0==this.sequence.length&&this.sequence.unshift(" ")):(this.shape.switchShape(this.shapeBuilder.letter(from),!0),0==this.sequence.length&&this.sequence.unshift(" ")),this.speed="count"==this.getNextCommand()?config.countSpeed:config.speed},countdown:function(command){var from,to,value=command.value.replace(/\s+/g,""),config=this.self.config,number=value.split(/from|to/);1==number.length?(from=parseInt(number[0]),to=config.minCount):2==number.length?/from/.test(value)?(from=parseInt(number[1]),to=config.minCount):(from=config.maxCount,to=parseInt(number[1])):3==number.length?value.indexOf("from")<value.indexOf("to")?(from=parseInt(number[1]),to=parseInt(number[2])):(from=parseInt(number[2]),to=parseInt(number[1])):(from=parseInt(value),to=config.minCount),from=isNaN(from)?config.maxCount:0>from?config.maxCount:from,to=isNaN(to)?config.minCount:0>to?config.minCount:to,from>to?(this.shape.switchShape(this.shapeBuilder.letter(from),!0),this.sequence.unshift(config.command+"countdown"+config.partition+"from"+(from-1)+"to"+to)):to>from?(this.shape.switchShape(this.shapeBuilder.letter(config.error)),0==this.sequence.length&&this.sequence.unshift(" ")):(this.shape.switchShape(this.shapeBuilder.letter(from),!0),0==this.sequence.length&&this.sequence.unshift(" ")),this.speed="countdown"==this.getNextCommand()?config.countSpeed:config.speed},rectangle:function(command){var value=command.value,config=this.self.config;value=value&&value.split("x"),value="object"==typeof value?value:[];var width=parseInt(value[0])||config.rectangleWidth,height=parseInt(value[1])||config.rectangleHeight;width=0>width?config.rectangleWidth:Math.min(config.maxShapeSize,width),height=0>height?config.rectangleHeight:Math.min(config.maxShapeSize,height),this.shape.switchShape(this.shapeBuilder.rectangle(width,height))},circle:function(command){var value=command.value,config=this.self.config;value=parseInt(value)||config.circleRadius,value=0>value?config.circleRadius:Math.min(value,config.maxShapeSize),this.shape.switchShape(this.shapeBuilder.circle(value))},time:function(command){var t,config=(command.value,this.self.config);"function"==typeof config.formatTime?(t=config.formatTime(new Date),"string"!=typeof t&&(t=formatTime(new Date))):t=formatTime(new Date),"time"==this.prevCommand?this.lasttime!=t?this.shape.switchShape(this.shapeBuilder.letter(t),!0,!0):this.stopTrigger=!0:this.shape.switchShape(this.shapeBuilder.letter(t)),this.lasttime=t,0==this.sequence.length&&this.sequence.unshift(config.command+"time"),this.speed="time"==this.getNextCommand()?config.timeSpeed:config.speed},icon:function(command){var value=command.value,config=this.self.config,self=this;this.shapeBuilder.imageFile(config.imgUrl+value+config.imgType,function(img){self.shape.switchShape(img)})},"default":function(command){var current=command.current,config=this.self.config;this.shape.switchShape(this.shapeBuilder.letter(0==current.indexOf(config.command)?config.error:current))}}),{simulate:function(action,callback){reset.call(this),performAction.call(this,action),timedAction.call(this,callback)},reset:function(){reset.call(this)},clear:function(){clear.call(this)}}}(),S.Point=function(args){this.x=args.x,this.y=args.y,this.z=args.z,this.a=args.a,this.h=args.h},S.Color=function(r,g,b,a){this.r=r,this.g=g,this.b=b,this.a=a},S.Color.prototype={render:function(){return["rgba(",this.r,",",this.g,",",this.b,",",this.a,")"].join("")}},S.Dot=function(x,y,color){this.p=new S.Point({x:x,y:y,z:5,a:color.a,h:0}),this.e=.07,this.s=!0,this.c=new S.Color(color.r,color.g,color.b,this.p.a),this.t=this.clone(),this.q=[]},S.Dot.prototype={clone:function(){return new S.Point({x:this.x,y:this.y,z:this.z,a:this.a,h:this.h})},_draw:function(drawing){this.c.a=this.p.a,S.Drawing.drawCircle.call(drawing,this.p,this.c)},_moveTowards:function(n){var details=this.distanceTo(n,!0),dx=details[0],dy=details[1],d=details[2],e=this.e*d;if(-1===this.p.h)return this.p.x=n.x,this.p.y=n.y,!0;if(d>1)this.p.x-=dx/d*e,this.p.y-=dy/d*e;else{if(!(this.p.h>0))return!0;this.p.h--}return!1},_update:function(){var ret;if(this._moveTowards(this.t)){var p=this.q.shift();p?(this.t.x=p.x||this.p.x,this.t.y=p.y||this.p.y,this.t.z=p.z||this.p.z,this.t.a=p.a||this.p.a,this.p.h=p.h||0,ret=!(p instanceof S.Point)):this.s?(this.p.x-=Math.sin(3.142*Math.random()),this.p.y-=Math.sin(3.142*Math.random())):this.move(new S.Point({x:this.p.x+50*Math.random()-25,y:this.p.y+50*Math.random()-25}))}return d=this.p.a-this.t.a,this.p.a=Math.max(.1,this.p.a-.05*d),d=this.p.z-this.t.z,this.p.z=Math.max(1,this.p.z-.05*d),ret},distanceTo:function(n,details){var dx=this.p.x-n.x,dy=this.p.y-n.y,d=Math.sqrt(dx*dx+dy*dy);return details?[dx,dy,d]:d},move:function(p,avoidStatic){(!avoidStatic||avoidStatic&&this.distanceTo(p)>1)&&this.q.push(p)},render:function(engine){var ret;return ret=this._update(),this._draw(engine.drawing),ret}},S.ShapeBuilder={_fit:function(){var canvas=(this.self.config,this.shapeCanvas),context=this.shapeContext;canvas.width=Math.floor(this.self.engine.drawing.canvas.width/this.gap)*this.gap,canvas.height=Math.floor(this.self.engine.drawing.canvas.height/this.gap)*this.gap,context.fillStyle="red",context.textBaseline="middle",context.textAlign="center"},processCanvas:function(){for(var pixels,pixels=this.shapeContext.getImageData(0,0,this.shapeCanvas.width,this.shapeCanvas.height).data,dots=[],x=0,y=0,fx=this.shapeCanvas.width,fy=this.shapeCanvas.height,w=0,h=0,p=0;p<pixels.length;p+=4*this.gap)pixels[p+3]>0&&(dots.push(new S.Point({x:x,y:y})),w=x>w?x:w,h=y>h?y:h,fx=fx>x?x:fx,fy=fy>y?y:fy),x+=this.gap,x>=this.shapeCanvas.width&&(x=0,y+=this.gap,p+=4*this.gap*this.shapeCanvas.width);return{dots:dots,w:w+fx,h:h+fy}},setFontSize:function(s){this.shapeContext.font="bold "+s+"px "+this.fontFamily},isNumber:function(n){return!isNaN(parseFloat(n))&&isFinite(n)},init:function(){this.fit(),$(window).on("resize",this.fit)},destroy:function(){$(window).off("resize",this.fit)},letter:function(l){var s=0;return this.setFontSize(this.fontSize),s=Math.min(this.fontSize,this.shapeCanvas.width/this.shapeContext.measureText(l).width*.8*this.fontSize,this.shapeCanvas.height*(this.isNumber(l)?.9:.75)),this.setFontSize(s),this.shapeContext.clearRect(0,0,this.shapeCanvas.width,this.shapeCanvas.height),this.shapeContext.fillText(l,this.shapeCanvas.width/2,this.shapeCanvas.height/2),this.processCanvas()},rectangle:function(w,h){for(var dots=[],width=this.gap*w,height=this.gap*h,y=0;height>y;y+=this.gap)for(var x=0;width>x;x+=this.gap)dots.push(new S.Point({x:x,y:y}));return{dots:dots,w:width,h:height}},circle:function(d){var r=Math.max(0,d)/2;return this.shapeContext.clearRect(0,0,this.shapeCanvas.width,this.shapeCanvas.height),this.shapeContext.beginPath(),this.shapeContext.arc(r*this.gap,r*this.gap,r*this.gap,0,2*Math.PI,!1),this.shapeContext.fill(),this.shapeContext.closePath(),this.processCanvas()},imageFile:function(url,callback){var image=new Image,a=this.self.engine.drawing.getArea(),self=this,config=this.self.config;image.onload=function(){self.shapeContext.clearRect(0,0,self.shapeCanvas.width,self.shapeCanvas.height);var w,h,cvsRatio=a.w/a.h,imgRatio=this.width/this.height;imgRatio>cvsRatio?(w=a.w,h=a.w/imgRatio):(w=a.h*imgRatio,h=a.h),w=.9*parseInt(w),h=.9*parseInt(h),self.shapeContext.drawImage(this,0,0,w,h),callback(self.processCanvas())},image.onerror=function(){callback(self.self.engine.shapeBuilder.letter(config.error))},image.src=url}},S.Shape={compensate:function(){var a=this.self.engine.drawing.getArea();this.cx=a.w/2-this.width/2,this.cy=a.h/2-this.height/2},shuffleIdle:function(){if(!this.shuffling)for(var a=this.self.engine.drawing.getArea(),d=0;d<this.dots.length;d++)this.dots[d].s||(this.dots[d].move({x:Math.random()*a.w,y:Math.random()*a.h}),this.shuffling++)},switchShape:function(n,fast,differOnly){var size,a=this.self.engine.drawing.getArea(),config=this.self.config;if(this.width=n.w,this.height=n.h,this.compensate(),n.dots.length>this.dots.length){size=n.dots.length-this.dots.length;for(var d=1;size>=d;d++)this.dots.push(new S.Dot(a.w/2,a.h/2,config.pointColor))}for(var d=0,i=0;n.dots.length>0;)i=Math.floor(Math.random()*n.dots.length),this.dots[d].e=fast?.25:this.dots[d].s?.14:.11,this.dots[d].s?this.dots[d].move(new S.Point({z:20*Math.random()+10,a:Math.random(),h:18})):this.dots[d].move(new S.Point({z:5*Math.random()+5,h:fast?18:30})),this.dots[d].s=!0,this.dots[d].move(new S.Point({x:n.dots[i].x+this.cx,y:n.dots[i].y+this.cy,a:config.shapeOpactiy,z:5,h:0})),n.dots=n.dots.slice(0,i).concat(n.dots.slice(i+1)),d++;for(var i=d;i<this.dots.length;i++)this.dots[i].s&&(this.dots[i].move(new S.Point({z:20*Math.random()+10,a:Math.random(),h:20})),this.dots[i].s=!1,this.dots[i].e=.04,this.dots[i].move(new S.Point({x:Math.random()*a.w,y:Math.random()*a.h,a:config.pointColor.a,z:4*Math.random(),h:0})))},render:function(){for(var d=0;d<this.dots.length;d++)this.dots[d].render(this.self.engine)&&(this.shuffling--,this.shuffling<0&&(this.shuffling=0),0==this.shuffling&&this.self.trigger("shuffle"))}};var defaults={content:$("[data-role=led-content]")[0],width:window.innerWidth,height:window.innerHeight,split:"|",command:"#",partition:" ",error:"What?",action:"hello",keyword:"led",minCount:1,maxCount:10,maxShapeSize:30,rectangleWidth:30,rectangleHeight:15,circleRadius:18,formatTime:function(date){var h=date.getHours(),m=date.getMinutes();return m=10>m?"0"+m:m,h+":"+m},imgUrl:"/img/icon/",imgType:".png",speed:2e3,countSpeed:1e3,timeSpeed:1e3,gap:13,fontSize:1e3,fontFamily:"Avenir, Helvetica Neue, Helvetica, Arial, sans-serif",pointColor:{r:255,g:102,b:51,a:.3},shapeOpactiy:.9},SS=function(self){this.self=self,this.sequence=[],this.timerId=0,this.speed=self.config.speed,this.prevCommand,this.destroyed=!1,this.drawing=new SDrawing(self),this.shapeBuilder=new SShapeBuilder(self),this.shape=new SShape(self)};SS.prototype=S,SS.prototype.getNextCommand=function(){return this.sequence.length>0&&this.sequence[0].split(this.self.config.partition).shift().split(this.self.config.command).pop()};var SDrawing=function(self){this.self=self,this.canvas=self.config.content,this.context=this.canvas.getContext("2d"),this.requestFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(callback){window.setTimeout(callback,1e3/60)}};SDrawing.prototype=S.Drawing;var SShapeBuilder=function(self){this.self=self,this.shapeCanvas=document.createElement("canvas"),this.shapeContext=this.shapeCanvas.getContext("2d"),this.gap=self.config.gap,this.fontSize=self.config.fontSize,this.fontFamily=self.config.fontFamily,this.fit=this._fit.bind(this)};SShapeBuilder.prototype=S.ShapeBuilder;var SShape=function(self){this.self=self,this.dots=[],this.width=0,this.height=0,this.cx=0,this.cy=0,this.shuffling=0};SShape.prototype=S.Shape;var e={};return LED.prototype={init:function(){return this.engine=new SS(this),this.engine.init(function(){if(this.engine.shapeBuilder.init(),this.trigger("init"),this.config.action!==!1){var ret;window.location.search.substring(1).split("&").forEach(function(kw){return kw.split("=").shift()===this.config.keyword?(this.simulate(decodeURI(kw.split("=").pop())),ret=!0,void 0):void 0}.bind(this)),ret||this.simulate(this.config.action)}}.bind(this)),this},render:function(width,height){return this.config.width=width,this.config.height=height,this.engine.drawing.adjustCanvas(),this},simulate:function(action){return this.stoped!==!1&&(this.stoped=!1),this.engine.Core.simulate.call(this.engine,action,function(command){this.trigger("action",command)}.bind(this)),this},reset:function(){return this.engine.Core.reset.call(this.engine),this.stoped!==!1&&(this.stoped=[]),this},clear:function(){return this.engine.Core.clear.call(this.engine),this},stop:function(){return this.stoped===!1&&(this.stoped=$.extend([],this.engine.sequence),this.reset()),this},start:function(){return this.stoped!==!1&&(this.simulate(this.stoped),this.stoped=!1),this},destroy:function(){return this.engine.shapeBuilder.destroy(),this.engine.destroyed=!0,this.engine=void 0,this},shuffle:function(){return this.engine.shape.shuffleIdle(),this},on:function(event,fn){return e[event]||(e[event]=[]),"function"==typeof fn&&e[event].push(fn),this},off:function(event,fn){if(!e[event])return this;for(var i=e[event].length-1;i>=0;i--)e[event][i]===fn&&e[event].splice(i,1);return this},trigger:function(event){var args=Array.prototype.splice.call(arguments,1),self=this;return e[event]?(e[event].forEach(function(i){i.apply(self,args)}),this):this}},function(conf){return document.createElement("canvas").getContext?new LED($.extend({},defaults,conf)):void 0}});